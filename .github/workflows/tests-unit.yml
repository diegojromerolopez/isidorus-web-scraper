name: Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests-unit:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage coverage-badge

      - name: Run API Unit Tests with Coverage
        run: |
          docker build -t isidorus-api-test -f api/Dockerfile .
          docker run --rm -v "$(pwd):/app" -e PYTHONPATH=/app isidorus-api-test sh -c "pip install coverage && coverage run --branch --source=api -m unittest discover -v -s tests/unit/api -t /app && coverage json -o /app/coverage-api.json && coverage report"

      - name: Run Image Extractor Unit Tests with Coverage
        run: |
          docker build -t isidorus-extractor-test -f workers/image_extractor/Dockerfile .
          docker run --rm -v "$(pwd):/app" -e PYTHONPATH=/app isidorus-extractor-test sh -c "pip install coverage && coverage run --branch --source=workers/image_extractor -m unittest discover -v -p 'test_*.py' -s tests/unit/workers/image_extractor -t /app && coverage json -o /app/coverage-extractor.json && coverage report"

      - name: Run Scraper Unit Tests with Coverage
        run: |
          docker build -t isidorus-scraper-test workers/scraper/
          docker run --rm -v "$(pwd):/app" -w /app/workers/scraper isidorus-scraper-test sh -c "go mod tidy && go test -v -coverprofile=/app/coverage-scraper.out -covermode=count ./... && go tool cover -func=/app/coverage-scraper.out | tee /app/coverage-scraper-summary.txt"

      - name: Run Writer Unit Tests with Coverage
        run: |
          docker build -t isidorus-writer-test workers/writer/
          docker run --rm -v "$(pwd):/app" -w /app/workers/writer isidorus-writer-test sh -c "go mod tidy && go test -v -coverprofile=/app/coverage-writer.out -covermode=count ./... && go tool cover -func=/app/coverage-writer.out | tee /app/coverage-writer-summary.txt"

      - name: Calculate Combined Coverage
        id: coverage
        run: |
          # Extract Python API coverage
          API_COV=$(python -c "import json; data=json.load(open('coverage-api.json')); print(f\"{data['totals']['percent_covered']:.1f}\")")
          echo "API Coverage: ${API_COV}%"
          
          # Extract Python Image Extractor coverage
          EXTRACTOR_COV=$(python -c "import json; data=json.load(open('coverage-extractor.json')); print(f\"{data['totals']['percent_covered']:.1f}\")")
          echo "Extractor Coverage: ${EXTRACTOR_COV}%"
          
          # Extract Go Scraper coverage from summary file
          SCRAPER_COV=$(grep "total:" coverage-scraper-summary.txt | awk '{print $3}' | sed 's/%//')
          echo "Scraper Coverage: ${SCRAPER_COV}%"
          
          # Extract Go Writer coverage from summary file
          WRITER_COV=$(grep "total:" coverage-writer-summary.txt | awk '{print $3}' | sed 's/%//')
          echo "Writer Coverage: ${WRITER_COV}%"
          
          # Validate all coverage values are present
          if [ -z "$API_COV" ] || [ -z "$EXTRACTOR_COV" ] || [ -z "$SCRAPER_COV" ] || [ -z "$WRITER_COV" ]; then
            echo "Error: One or more coverage values are missing"
            echo "API_COV=$API_COV, EXTRACTOR_COV=$EXTRACTOR_COV, SCRAPER_COV=$SCRAPER_COV, WRITER_COV=$WRITER_COV"
            exit 1
          fi
          
          # Calculate average coverage
          TOTAL_COV=$(python -c "print(f\"{(${API_COV} + ${EXTRACTOR_COV} + ${SCRAPER_COV} + ${WRITER_COV}) / 4:.1f}\")")
          echo "Total Coverage: ${TOTAL_COV}%"

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage-api.json
            coverage-extractor.json
            coverage-scraper.out
            coverage-scraper-summary.txt
            coverage-writer.out
            coverage-writer-summary.txt
          retention-days: 30
