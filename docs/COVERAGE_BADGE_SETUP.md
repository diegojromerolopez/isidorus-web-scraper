# Coverage Badge Setup Guide

This guide explains how to set up the dynamic coverage badge for the Isidorus Web Scraper project.

## Overview

The coverage badge is automatically generated by the GitHub Actions workflow (`tests-unit.yml`) and displays the combined test coverage from all components:
- **API** (Python/FastAPI)
- **Image Extractor** (Python)
- **Scraper** (Go)
- **Writer** (Go)

The badge is stored in a GitHub Gist and updated automatically on every push to the `main` branch.

## Setup Instructions

### Step 1: Create a GitHub Personal Access Token (PAT)

1. Go to GitHub Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)
2. Click "Generate new token (classic)"
3. Give it a descriptive name like "Coverage Badge Token"
4. Select the following scope:
   - âœ… **gist** (Create gists)
5. Click "Generate token"
6. **Copy the token** (you won't be able to see it again!)

### Step 2: Create a GitHub Gist

1. Go to https://gist.github.com/
2. Create a new gist with:
   - **Filename**: `isidorus-coverage.json`
   - **Content**: 
     ```json
     {
       "schemaVersion": 1,
       "label": "coverage",
       "message": "0%",
       "color": "red"
     }
     ```
3. Click "Create secret gist" or "Create public gist" (public is recommended for badges)
4. **Copy the Gist ID** from the URL (e.g., `https://gist.github.com/username/GIST_ID`)

### Step 3: Add GitHub Secrets to Your Repository

1. Go to your repository on GitHub
2. Navigate to Settings â†’ Secrets and variables â†’ Actions
3. Click "New repository secret" and add:
   - **Name**: `GIST_SECRET`
   - **Value**: The Personal Access Token from Step 1
4. Click "Add secret"
5. Click "New repository secret" again and add:
   - **Name**: `GIST_ID`
   - **Value**: The Gist ID from Step 2 (just the ID part, not the full URL)
6. Click "Add secret"

### Step 4: Update the README Badge URL

1. Open `README.md`
2. Find the coverage badge line:
   ```markdown
   [![Coverage](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/diegojromerolopez/GIST_ID/raw/isidorus-coverage.json)](https://github.com/diegojromerolopez/isidorus-web-scraper/actions/workflows/tests-unit.yml)
   ```
3. Replace `GIST_ID` with your actual Gist ID from Step 2
4. Commit and push the change

### Step 5: Trigger the Workflow

1. Push a commit to the `main` branch, or
2. Manually trigger the workflow from the Actions tab

The coverage badge will be automatically updated with the latest coverage percentage!

## How It Works

1. **Test Execution**: The workflow runs all unit tests with coverage enabled
2. **Coverage Calculation**: 
   - Python tests generate `coverage-api.json` and `coverage-extractor.json`
   - Go tests generate `coverage-scraper.out` and `coverage-writer.out`
3. **Combined Coverage**: The workflow calculates the average coverage across all components
4. **Badge Update**: The badge is updated in the Gist with the new coverage percentage
5. **Color Coding**:
   - ðŸŸ¢ **Bright Green**: â‰¥90%
   - ðŸŸ¢ **Green**: â‰¥80%
   - ðŸŸ¡ **Yellow-Green**: â‰¥70%
   - ðŸŸ¡ **Yellow**: â‰¥60%
   - ðŸ”´ **Red**: <60%

## Troubleshooting

### Badge Not Updating

- Verify that `GIST_SECRET` and `GIST_ID` are correctly set in repository secrets
- Check the GitHub Actions logs for any errors
- Ensure the PAT has the `gist` scope enabled
- Make sure the Gist is public (or accessible with the token)

### Badge Shows "invalid"

- The Gist ID in the README might be incorrect
- The Gist file might not exist or be named incorrectly
- Wait a few minutes for the CDN cache to update

### Coverage Calculation Errors

- Check that all coverage files are being generated correctly
- Review the "Calculate Combined Coverage" step in the workflow logs
- Ensure `bc` is available in the runner (it should be by default on Ubuntu)

## Manual Badge Update

If you need to manually update the badge, you can edit the Gist directly:

```json
{
  "schemaVersion": 1,
  "label": "coverage",
  "message": "95.5%",
  "color": "brightgreen"
}
```

## Alternative: Using Codecov or Coveralls

If you prefer using a third-party service instead of GitHub Gists, you can use:

- **Codecov**: https://codecov.io/
- **Coveralls**: https://coveralls.io/

Both services offer free plans for open-source projects and provide more detailed coverage reports and visualizations.
